{% extends "base.html" %}
{% block title %}Dashboard â€” SHIELDX{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Dashboard</h1>
        <p class="page-subtitle">Real-time security overview</p>
    </div>
    <div style="display:flex; gap:0.75rem; align-items:center;">
        <span id="live-badge" class="live-badge" title="Charts refresh every 30s">â¬¤ LIVE</span>
        <a href="{{ url_for('main.scan_page') }}" class="btn btn-primary">ğŸ” New Scan</a>
    </div>
</div>

<!-- â•â•â• STAT CARDS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="stats-grid" style="margin-bottom:1.5rem;">
    <div class="stat-card">
        <div class="stat-icon stat-blue">ğŸ“</div>
        <div class="stat-info">
            <p class="stat-value" id="stat-total">{{ stats.total_scans }}</p>
            <p class="stat-label">Total Scans</p>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon stat-red">âš ï¸</div>
        <div class="stat-info">
            <p class="stat-value" id="stat-threats">{{ stats.threats_found }}</p>
            <p class="stat-label">Threats Found</p>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon stat-green">âœ…</div>
        <div class="stat-info">
            <p class="stat-value" id="stat-clean">{{ stats.clean_files }}</p>
            <p class="stat-label">Clean Files</p>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon stat-orange">ğŸ”¥</div>
        <div class="stat-info">
            <p class="stat-value" id="stat-critical">{{ stats.critical }}</p>
            <p class="stat-label">Critical Threats</p>
        </div>
    </div>
</div>

<!-- â•â•â• CHARTS GRID â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="dash-charts-grid">

    <!-- Row 1: Trend Line (wide) + Verdict Doughnut -->
    <div class="glass-card dash-chart-wide">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
            <h3 class="card-title">ğŸ“ˆ Scan &amp; Threat Trend â€” Last 7 Days</h3>
            <span class="chart-pill" id="trend-total-pill"></span>
        </div>
        <div style="position:relative; height:200px;">
            <canvas id="chartTrend"></canvas>
        </div>
    </div>

    <div class="glass-card dash-chart-narrow">
        <h3 class="card-title" style="margin-bottom:1rem;">ğŸ¥§ Verdict Split</h3>
        <div style="position:relative; height:170px;">
            <canvas id="chartVerdict"></canvas>
        </div>
        <div id="verdict-legend"
            style="display:flex; justify-content:center; gap:1rem; margin-top:0.75rem; font-size:0.8rem;"></div>
    </div>

    <!-- Row 2: Severity Bar + File Types Doughnut + Top Threats -->
    <div class="glass-card dash-chart-narrow">
        <h3 class="card-title" style="margin-bottom:1rem;">ğŸ“Š Severity Breakdown</h3>
        <div style="position:relative; height:200px;">
            <canvas id="chartSeverity"></canvas>
        </div>
    </div>

    <div class="glass-card dash-chart-narrow">
        <h3 class="card-title" style="margin-bottom:1rem;">ğŸ“‚ File Types Scanned</h3>
        <div style="position:relative; height:200px;">
            <canvas id="chartFileTypes"></canvas>
        </div>
    </div>

    <div class="glass-card dash-chart-narrow">
        <h3 class="card-title" style="margin-bottom:0.75rem;">ğŸ¦  Top Threats Detected</h3>
        <div style="position:relative; height:200px;">
            <canvas id="chartThreats"></canvas>
        </div>
        <p id="no-threats-msg"
            style="display:none; text-align:center; color:var(--text-muted); font-size:0.85rem; margin-top:1rem;">
            âœ… No threats detected yet
        </p>
    </div>

</div>

<!-- â•â•â• THREAT HEALTH BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
{% if stats.total_scans > 0 %}
<div class="glass-card" style="margin-bottom:1.5rem;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem;">
        <h3 class="card-title">ğŸ›¡ï¸ Overall Security Health</h3>
        {% set clean_pct = ((stats.clean_files / stats.total_scans) * 100) | round(1) %}
        <span
            style="font-size:0.85rem; color:{{ 'var(--green)' if clean_pct >= 80 else ('var(--orange)' if clean_pct >= 50 else 'var(--red)') }}; font-weight:700;">
            {{ clean_pct }}% Clean
        </span>
    </div>
    {% set threat_pct = ((stats.threats_found / stats.total_scans) * 100) | round(1) %}
    <div style="display:flex; justify-content:space-between; margin-bottom:6px; font-size:0.82rem;">
        <span style="color:var(--green);">âœ… Clean: {{ clean_pct }}%</span>
        <span style="color:var(--red);">âš ï¸ Threats: {{ threat_pct }}%</span>
    </div>
    <div class="health-bar-bg">
        <div class="health-bar-fill" style="width: {{ clean_pct }}%"></div>
    </div>
</div>
{% endif %}

<!-- â•â•â• RECENT SCANS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="glass-card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
        <h3 class="card-title">ğŸ• Recent Scans</h3>
        <a href="{{ url_for('main.history_page') }}" class="btn btn-ghost btn-sm">View All â†’</a>
    </div>
    {% if recent %}
    <div class="table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th>File Name</th>
                    <th>Status</th>
                    <th>Severity</th>
                    <th>Scanned At</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in recent %}
                <tr class="{{ 'row-threat' if entry.is_malicious else 'row-clean' }}">
                    <td class="file-name-cell">ğŸ“„ {{ entry.file_name }}</td>
                    <td>
                        {% if entry.is_malicious %}
                        <span class="badge badge-danger">âš ï¸ THREAT</span>
                        {% else %}
                        <span class="badge badge-success">âœ… CLEAN</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if entry.severity %}
                        <span class="badge badge-{{ entry.severity | lower }}">{{ entry.severity }}</span>
                        {% else %}<span style="color:var(--text-muted)">â€”</span>{% endif %}
                    </td>
                    <td style="color:var(--text-muted); font-size:0.85rem;">{{ entry.scanned_at }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <p style="font-size:3rem;">ğŸ”</p>
        <p>No scans yet. <a href="{{ url_for('main.scan_page') }}" class="link">Run your first scan</a></p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Chart.js v4 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

<style>
    /* â”€â”€ Live badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .live-badge {
        font-size: 0.72rem;
        font-weight: 700;
        letter-spacing: 0.05em;
        color: var(--green);
        animation: pulse-dot 2s infinite;
    }

    @keyframes pulse-dot {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.3;
        }
    }

    /* â”€â”€ Charts Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dash-charts-grid {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr;
        gap: 1.25rem;
        margin-bottom: 1.5rem;
    }

    .dash-chart-wide {
        grid-column: span 2;
    }

    .dash-chart-narrow {
        grid-column: span 1;
    }

    @media (max-width: 960px) {
        .dash-charts-grid {
            grid-template-columns: 1fr 1fr;
        }

        .dash-chart-wide {
            grid-column: span 2;
        }
    }

    @media (max-width: 600px) {
        .dash-charts-grid {
            grid-template-columns: 1fr;
        }

        .dash-chart-wide,
        .dash-chart-narrow {
            grid-column: span 1;
        }
    }

    /* â”€â”€ Pill label â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .chart-pill {
        font-size: 0.72rem;
        font-weight: 700;
        padding: 0.2rem 0.65rem;
        background: hsl(213, 94%, 60%, 0.12);
        color: var(--blue);
        border: 1px solid hsl(213, 94%, 60%, 0.25);
        border-radius: 99px;
    }
</style>

<script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  Global Chart.js dark-theme defaults
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    Chart.defaults.color = 'hsl(215,20%,55%)';
    Chart.defaults.borderColor = 'hsl(222,22%,18%)';
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.font.size = 12;
    Chart.defaults.plugins.legend.labels.boxWidth = 12;
    Chart.defaults.plugins.legend.labels.padding = 14;
    Chart.defaults.plugins.tooltip.backgroundColor = 'hsl(222,28%,14%)';
    Chart.defaults.plugins.tooltip.borderColor = 'hsl(222,22%,22%)';
    Chart.defaults.plugins.tooltip.borderWidth = 1;
    Chart.defaults.plugins.tooltip.padding = 10;
    Chart.defaults.plugins.tooltip.cornerRadius = 8;
    Chart.defaults.plugins.tooltip.titleColor = 'hsl(215,30%,90%)';
    Chart.defaults.plugins.tooltip.bodyColor = 'hsl(215,20%,70%)';

    // Palette
    const C = {
        blue: 'hsl(213,94%,60%)',
        blueFade: 'hsl(213,94%,60%,0.15)',
        red: 'hsl(0,85%,60%)',
        redFade: 'hsl(0,85%,60%,0.15)',
        green: 'hsl(142,71%,45%)',
        orange: 'hsl(38,92%,50%)',
        purple: 'hsl(270,65%,65%)',
        cyan: 'hsl(195,90%,55%)',
        yellow: 'hsl(55,90%,55%)',
    };

    // â”€â”€ Chart instances (kept so we can destroy + rebuild on refresh) â”€â”€
    let charts = {};

    function destroyChart(id) {
        if (charts[id]) { charts[id].destroy(); delete charts[id]; }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  Gradient helper
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function makeGradient(ctx, colorTop, colorBot) {
        const g = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
        g.addColorStop(0, colorTop);
        g.addColorStop(1, colorBot);
        return g;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  Build / Refresh all charts
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadCharts() {
        try {
            const resp = await fetch('/api/chart-data');
            const d = await resp.json();
            buildTrendChart(d.daily);
            buildVerdictChart(d.verdict);
            buildSeverityChart(d.severity);
            buildFileTypesChart(d.file_types);
            buildThreatsChart(d.top_threats);
            // Update stat cards live
            const stats = await fetch('/api/stats');
            const s = await stats.json();
            animateCounter(document.getElementById('stat-total'), s.total_scans);
            animateCounter(document.getElementById('stat-threats'), s.threats_found);
            animateCounter(document.getElementById('stat-clean'), s.clean_files);
            animateCounter(document.getElementById('stat-critical'), s.critical);
        } catch (e) {
            console.warn('Chart load failed:', e);
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  1. TREND LINE: Scans vs Threats â€” 7 days
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function buildTrendChart(daily) {
        destroyChart('trend');
        const canvas = document.getElementById('chartTrend');
        const ctx = canvas.getContext('2d');

        const totalScans = daily.scans.reduce((a, b) => a + b, 0);
        const totalThreats = daily.threats.reduce((a, b) => a + b, 0);
        document.getElementById('trend-total-pill').textContent =
            `${totalScans} scans Â· ${totalThreats} threats this week`;

        charts.trend = new Chart(ctx, {
            type: 'line',
            data: {
                labels: daily.labels,
                datasets: [
                    {
                        label: 'Total Scans',
                        data: daily.scans,
                        borderColor: C.blue,
                        backgroundColor: makeGradient(ctx, 'hsl(213,94%,60%,0.25)', 'hsl(213,94%,60%,0.02)'),
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: C.blue,
                        borderWidth: 2.5,
                    },
                    {
                        label: 'Threats',
                        data: daily.threats,
                        borderColor: C.red,
                        backgroundColor: makeGradient(ctx, 'hsl(0,85%,60%,0.22)', 'hsl(0,85%,60%,0.02)'),
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: C.red,
                        borderWidth: 2.5,
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: { legend: { position: 'top' } },
                scales: {
                    x: { grid: { color: 'hsl(222,22%,16%)' } },
                    y: {
                        grid: { color: 'hsl(222,22%,16%)' },
                        beginAtZero: true,
                        ticks: { stepSize: 1 },
                    },
                },
            },
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  2. DOUGHNUT: Verdict Split
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function buildVerdictChart(verdict) {
        destroyChart('verdict');
        const ctx = document.getElementById('chartVerdict').getContext('2d');
        const total = verdict.clean + verdict.threats;

        charts.verdict = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Clean', 'Threats'],
                datasets: [{
                    data: total > 0 ? [verdict.clean, verdict.threats] : [1, 0],
                    backgroundColor: [C.green, C.red],
                    borderColor: 'hsl(222,28%,12%)',
                    borderWidth: 3,
                    hoverOffset: 6,
                }],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                const pct = total > 0 ? ((ctx.raw / total) * 100).toFixed(1) : 0;
                                return ` ${ctx.label}: ${ctx.raw} (${pct}%)`;
                            }
                        }
                    }
                },
            },
            plugins: [{
                id: 'centerText',
                afterDraw(chart) {
                    const { ctx, chartArea: { top, left, width, height } } = chart;
                    const cx = left + width / 2, cy = top + height / 2;
                    const pct = total > 0 ? ((verdict.clean / total) * 100).toFixed(0) : 100;
                    ctx.save();
                    ctx.textAlign = 'center';
                    ctx.fillStyle = 'hsl(215,30%,90%)';
                    ctx.font = `bold 1.4rem Inter, sans-serif`;
                    ctx.fillText(pct + '%', cx, cy + 2);
                    ctx.font = `0.68rem Inter, sans-serif`;
                    ctx.fillStyle = 'hsl(215,20%,55%)';
                    ctx.fillText('clean', cx, cy + 18);
                    ctx.restore();
                }
            }],
        });

        // Custom legend
        document.getElementById('verdict-legend').innerHTML = `
        <span style="color:${C.green}">â— ${verdict.clean} Clean</span>
        <span style="color:${C.red}">â— ${verdict.threats} Threats</span>
    `;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  3. BAR: Severity Breakdown
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function buildSeverityChart(sev) {
        destroyChart('severity');
        const ctx = document.getElementById('chartSeverity').getContext('2d');
        charts.severity = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Low', 'Medium', 'High', 'Critical'],
                datasets: [{
                    label: 'Files',
                    data: [sev.LOW, sev.MEDIUM, sev.HIGH, sev.CRITICAL],
                    backgroundColor: [
                        'hsl(142,71%,45%,0.75)',
                        'hsl(38,92%,50%,0.75)',
                        'hsl(25,90%,55%,0.75)',
                        'hsl(0,85%,60%,0.75)',
                    ],
                    borderColor: [C.green, C.orange, 'hsl(25,90%,55%)', C.red],
                    borderWidth: 1.5,
                    borderRadius: 6,
                }],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false } },
                    y: {
                        grid: { color: 'hsl(222,22%,16%)' },
                        beginAtZero: true,
                        ticks: { stepSize: 1 },
                    },
                },
            },
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  4. DOUGHNUT: File Types Scanned
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function buildFileTypesChart(ft) {
        destroyChart('fileTypes');
        const ctx = document.getElementById('chartFileTypes').getContext('2d');
        const colors = [C.blue, C.cyan, C.purple, C.green, C.orange, C.yellow, C.red];
        const empty = !ft.labels.length;
        charts.fileTypes = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: empty ? ['No Data'] : ft.labels,
                datasets: [{
                    data: empty ? [1] : ft.data,
                    backgroundColor: empty ? ['hsl(222,22%,20%)'] : colors,
                    borderColor: 'hsl(222,28%,12%)',
                    borderWidth: 3,
                    hoverOffset: 5,
                }],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '55%',
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { font: { size: 11 }, padding: 8, boxWidth: 10 },
                    },
                },
            },
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  5. HORIZONTAL BAR: Top Threats
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function buildThreatsChart(tt) {
        destroyChart('threats');
        const empty = !tt.labels.length;
        document.getElementById('no-threats-msg').style.display = empty ? 'block' : 'none';
        if (empty) return;

        const ctx = document.getElementById('chartThreats').getContext('2d');
        charts.threats = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: tt.labels,
                datasets: [{
                    label: 'Detections',
                    data: tt.data,
                    backgroundColor: 'hsl(0,85%,60%,0.65)',
                    borderColor: C.red,
                    borderWidth: 1.5,
                    borderRadius: 5,
                }],
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: { label: ctx => ` ${ctx.raw} detection${ctx.raw !== 1 ? 's' : ''}` }
                    },
                },
                scales: {
                    x: {
                        grid: { color: 'hsl(222,22%,16%)' },
                        beginAtZero: true,
                        ticks: { stepSize: 1 },
                    },
                    y: {
                        grid: { display: false },
                        ticks: {
                            font: { size: 10.5 },
                            callback: v => v.length > 20 ? v.substring(0, 18) + 'â€¦' : v,
                        },
                    },
                },
            },
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  Counter animation helper
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function animateCounter(el, target) {
        if (!el) return;
        const cur = parseInt(el.textContent) || 0;
        if (cur === target) return;
        const step = Math.ceil(Math.abs(target - cur) / 20);
        let v = cur;
        const iv = setInterval(() => {
            v = target > cur ? Math.min(v + step, target) : Math.max(v - step, target);
            el.textContent = v;
            if (v === target) clearInterval(iv);
        }, 40);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  Auto-refresh every 30 seconds
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    loadCharts();
    // Animate stat counters on initial load
    document.querySelectorAll('.stat-value').forEach(el => {
        const t = parseInt(el.textContent);
        el.textContent = 0;
        animateCounter(el, t);
    });

    // Refresh every 30 s
    setInterval(() => {
        const badge = document.getElementById('live-badge');
        badge.style.color = 'var(--orange)';
        badge.textContent = 'â¬¤ UPDATING';
        loadCharts().finally(() => {
            badge.style.color = 'var(--green)';
            badge.textContent = 'â¬¤ LIVE';
        });
    }, 30000);
</script>
{% endblock %}